<html>
<head>
<title>DOE Question Template Generator</title>
<meta name="viewport" content="width=device-width">
</head>
<body style="font-family:Arial">
<style>
.main{
width:85%;border:solid 1px #000000;padding:20px;margin:20px auto;
}
#subjdisplay{
border:solid 1px black;padding:10px;
}
#nsform{
width:100%;
}
#nsform input{
width:90%;
text-align:center;
}
#nsform td{
text-align:center;
}
#addbtn{
display:block;
width:30px;height:30px;
border-radius:30px;text-align:center;
font-size:2em;
padding:0px 0px 0px 0px;
margin:0px auto;
}
.xbtn{
font-weight:bold;
color:red;
}
.xbtn:hover{
cursor:pointer;
}

</style>
<div class='main'>
	<h2>DOE Question Template Generator</h2>
	<small>Based on the subjects-per-person given, generates a DOE questions template with question assignments.</small>
	<br><br>
	<div id="subjdisplay"><b>Subject Key:</b><br></div>
	<br>
	<table id='nsform'>
		<tr id='nstitle'><th>Name<th><th>Subject<th>
		<tr><td><td><button class='addbtn' onclick="nsadd('','');">+</button><td><td>
	</table>
	<div style="text-align:center;width:100%;"></div>
	<br>
	<button onclick="genTemplate();generateLink();saveQCookie();selTemplate();">Generate Template</button>
	<div style="max-width:100%;">Permalink: <a id="doclink" href="">(n/a)</a></div><br><br>
	<div id="html" style="border:solid 1px #000000;" onclick="selTemplate();"><center style="font-style:italic;">template to be here</center></div>
</div>
<div style="width:60%;color:white;background-color:black;border-radius:100px;margin:20px auto;text-align:center;font-weight:bold;">&copy;2014 LHS Scibowl</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="js/jquery-1.10.2.min.js">\x3C/script>')</script>
<script src="js/jquery.jsoncookie.js"></script>
<script>
/******CONFIG******/
var SUBJTRANSLATE={b:"BIOLOGY",c:"CHEMISTRY",p:"PHYSICS",m:"MATH",e:"EARTH AND SPACE SCIENCE",n:"ENERGY"};
/******ENDCNF******/
for(var i in SUBJTRANSLATE)$('#subjdisplay').append(i+'='+SUBJTRANSLATE[i]+'<br>');

function nsadd(n,s){$('#nstitle').after('<tr><td><input class="name" value="'+htmlentities(n)+'"/><td><td><input class="subj" value="'+htmlentities(s)+'"/><td class="xbtn" onclick="$(this).parents(\'tr\').remove();">x');}
function selTemplate(){
	if(window.getSelection())window.getSelection().selectAllChildren(document.getElementById('html'));
	else alert("Your browser doesn't support selection properly D: You can probably just manually select the entire document and that'll do just fine.");
}
function generateLink(){
	getstr="?";
	var names=$(".name");
	names.each(function(){getstr+=encodeURIComponent(this.value)+'='+encodeURIComponent($(".subj").get(names.index(this)).value)+'&';});
	var linktext=location.origin+location.pathname+getstr;
	$("#doclink").text(linktext).attr('href',linktext);
}
function saveQCookie(){
	var cookiearr=[];
	$(".name").each(function(){cookiearr.push([this.value,$(".subj").get($(".name").index(this)).value]);});
	$.cookie("qcook",cookiearr);
}
function genTemplate(){
	var qarr=[];
	$(".name").each(function(){
		var sv=$(".subj").get($(".name").index(this)).value;
		for(var i=0;i<sv.length;i+=2){
			if(!parseInt(sv[i])){alert("Invalid subject number for '"+htmlentities(this.value)+"'");return false;}
			if(!(s=SUBJTRANSLATE[sv[i+1].toLowerCase()])){alert("Invalid subject for '"+htmlentities(this.value)+"'");return false;}
			for(var j=0;j<parseInt(sv[i]);j++)
				qarr.push([s,this.value]);
		}
	});
	qarr=mooShuffle(qarr);
	
	var fullhtml="<p style='text-align:center;font-weight:bold;'>[[team]]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DOE Questions&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[[date]]</p>";
	var x=["TOSS-UP","BONUS"];
	for(var i=0;i<qarr.length;i++)for(var j=0;j<x.length;j++)
		fullhtml+="<p style='text-align:center;font-weight:bold;'>"+x[j]+"</p>"
			+"<div style='font-weight:normal;'>"+(i+1)+") "+htmlentities(qarr[i][0])+" <i>Question Type</i> "+htmlentities(qarr[i][1])+"</div>"
			+"<div style='font-weight:normal;'>ANSWER:&nbsp;</div>";
	$("#html").html(fullhtml+"<br>");
}
function mooShuffle(arr){//Fisher-Yates Shuffle, but which I discovered myself independently. So I get to name it ^^
	var ind,tmp;
	for(var i=arr.length-1;i>0;i--){
		ind=Math.floor(Math.random()*i);//Get random one
		tmp=arr[i];arr[i]=arr[ind];arr[ind]=tmp;//Swap with last one in sorted area
	}
	return arr;
}
function htmlentities(str) {//http://css-tricks.com/snippets/javascript/htmlentities-for-javascript/
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

//Fetch data from memory
//if GET parameters, override everything; else if cookie fill it in, otherwise just single blank.
var getarr={},nsarr=[],a=location.search.substr(1).split('&');
for(var i=0;i<a.length;i++){var x=a[i].split('=');if(!x[0]||!x[1])continue;getarr[decodeURIComponent(x[0])]=decodeURIComponent(x[1]);}
if(getarr){for(var key in getarr)if(getarr.hasOwnProperty(key))nsarr.push([key,getarr[key]]);}
else if((nsarr=$.cookie("qcook")).length==0)nsarr=[['','']];
for(var i=0;i<nsarr.length;i++)nsadd(nsarr[i][0],nsarr[i][1]);
if(nsarr.length==0)nsadd('','');
else{
	genTemplate();
	generateLink();
}
</script>
</body>
</html>